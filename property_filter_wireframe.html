<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property Filter</title>
  <style>
    :root{
      --primary:#4838a2;
      --secondary:#7b68ee;
      --text:#000;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card-bg:#fff;
    }
    body {
      font-family: 'Roboto Flex', sans-serif;
      background-color: #ffffff;
      color: var(--text);
      padding: 0;
      margin: 0;
    }
    .wrap{ max-width: 720px; margin: 32px auto; padding: 0 16px; }

    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      background: var(--card-bg);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .full{ grid-column: 1 / -1; }

    label { display:block; font-weight:600; font-size:14px; color:#111827; }
    .hint{ font-size:12px; color:var(--muted); margin-top:4px; transition: color 0.2s ease; }
    
    .selection-count {
      display: inline-block;
      background: var(--primary);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
      animation: countPulse 0.3s ease;
    }

    @keyframes countPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    input[type="text"], input[type="number"] {
      width: 95%; padding: 10px 12px; margin-top: 8px; border: 1px solid #ccc;
      border-radius: 10px; font-size: 16px !important;
      transition: all 0.2s ease;
    }

    input[type="text"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(72, 56, 162, 0.1);
    }

    /* Budget/Radius section styles */
    .budget-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    .budget-input-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
    }

    .currency-symbol {
      position: absolute;
      left: 12px;
      color: var(--muted);
      font-weight: 600;
      font-size: 16px;
      z-index: 1;
      pointer-events: none;
    }

    .budget-input-wrapper input[type="number"] {
      width: 100%;
      padding: 10px 12px 10px 32px; /* Default padding for money */
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.2s ease;
      margin-top: 0;
    }

    .budget-input-wrapper input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(72, 56, 162, 0.1);
    }

    .budget-increase-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(72, 56, 162, 0.2);
      white-space: nowrap;
    }

    .budget-increase-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(72, 56, 162, 0.3);
    }

    .budget-increase-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(72, 56, 162, 0.2);
    }

    .btn-icon {
      font-size: 18px;
      font-weight: bold;
      line-height: 1;
    }

    /* Radius number input styles */
    .radius-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    .radius-input-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
    }

    .radius-input-wrapper input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.2s ease;
      margin-top: 0;
      text-align: center;
    }

    .radius-input-wrapper input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(72, 56, 162, 0.1);
    }

    .radius-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(72, 56, 162, 0.2);
      min-width: 44px;
      height: 44px;
    }

    .radius-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(72, 56, 162, 0.3);
    }

    .radius-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(72, 56, 162, 0.2);
    }

    .radius-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .radius-btn:disabled:hover {
      transform: none;
      box-shadow: 0 2px 8px rgba(72, 56, 162, 0.2);
    }

    /* Multiselect styles */
    .multiselect-container {
      position: relative;
      width: 100%;
      margin-top: 8px;
    }

    .multiselect-display {
      width: 95%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
      background: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: border-color 0.2s ease;
    }

    .multiselect-display:hover {
      border-color: var(--primary);
    }

    .multiselect-placeholder {
      color: #999;
    }

    .multiselect-arrow {
      color: var(--muted);
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .multiselect-container.active .multiselect-arrow {
      transform: rotate(180deg);
    }

    .multiselect-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      width: 95%;
      background: white;
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-top: -1px;
    }

    .multiselect-option {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .multiselect-option:last-child {
      border-bottom: none;
    }

    .multiselect-option:hover {
      background-color: #f8f7ff;
    }

    .multiselect-option input[type="checkbox"] {
      width: auto;
      margin: 0;
      cursor: pointer;
    }

    .multiselect-option label {
      cursor: pointer;
      font-weight: normal;
      margin: 0;
      flex: 1;
    }

    .multiselect-selected {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .multiselect-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #eef2ff 0%, #dfe3ff 100%);
      color: var(--primary);
      border: 1px solid #c7d2fe;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      animation: tagSlideIn 0.3s ease;
      box-shadow: 0 2px 4px rgba(72, 56, 162, 0.1);
    }

    @keyframes tagSlideIn {
      from { opacity: 0; transform: scale(0.8) translateY(-5px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    @keyframes tagSlideOut {
      from { opacity: 1; transform: scale(1) translateY(0); }
      to { opacity: 0; transform: scale(0.8) translateY(-5px); }
    }

    .multiselect-tag-remove {
      cursor: pointer;
      font-weight: bold;
      color: var(--primary);
      font-size: 18px;
      line-height: 1;
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      margin-left: 2px;
    }

    /* Autocomplete dropdown styles */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      display: none;
      animation: dropdownSlideDown 0.2s ease;
    }

    @keyframes dropdownSlideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .autocomplete-dropdown::-webkit-scrollbar { width: 6px; }
    .autocomplete-dropdown::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .autocomplete-dropdown::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

    .autocomplete-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .autocomplete-item:last-child { border-bottom: none; }
    .autocomplete-item .name { font-weight: 500; font-size: 14px; flex: 1; }
    .autocomplete-item .type { display: none; }

    .autocomplete-item.selected-item {
      background-color: #eef2ff;
      border-left: 3px solid var(--primary);
    }
    .autocomplete-item.selected-item .name { color: var(--primary); font-weight: 600; }
    .autocomplete-item.selected-item .name::before {
      content: '✓'; display: inline-flex; align-items: center; justify-content: center;
      width: 18px; height: 18px; background-color: var(--primary); color: white;
      border-radius: 50%; font-size: 12px; font-weight: bold; margin-right: 10px; flex-shrink: 0;
    }
    .autocomplete-item:not(.selected-item) .name::before {
      content: ''; display: inline-block; width: 18px; height: 18px;
      border: 2px solid #d1d5db; border-radius: 4px; margin-right: 10px; flex-shrink: 0;
    }

    .loading {
      padding: 12px 16px; text-align: center; color: var(--muted); font-size: 14px;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .loading::before {
      content: ''; width: 16px; height: 16px; border: 2px solid var(--border);
      border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .no-results { padding: 12px 16px; text-align: center; color: var(--muted); font-size: 14px; font-style: italic; }
    .action-btn { margin-top: 12px; width: 100%; background-color: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s ease; }

    /* Results - Compact Professional Design */
    .results{ margin-top:16px; display:grid; grid-template-columns: 1fr; gap:10px; }
    .result-count{ 
      background:#ffffff; 
      border:1px solid var(--border); 
      border-radius:8px; 
      padding:12px 16px; 
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .result-count .num{ 
      font-size:26px; 
      font-weight:700; 
      color:var(--primary);
      line-height: 1;
    }
    .result-count .sub{ 
      font-size:12px; 
      color:#6b7280; 
      margin:0;
      font-weight: 500;
      line-height: 1.4;
    }

    .result-section{ border:1px solid var(--border); border-radius:8px; padding:12px 16px; margin-bottom: 0; }
    .section-title{ font-size:14px; font-weight:700; color:#111827; margin-bottom:8px; }
    
    /* Professional section title for adjacent localities */
    #adjacentLocalitiesSection .section-title {
      font-size: 12px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    #adjacentLocalitiesSection .section-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--primary);
      border-radius: 2px;
      display: inline-block;
    }
    .pill{ display:inline-block; background:#eef2ff; color:var(--primary); border:1px solid #dfe3ff; padding:6px 10px; border-radius:999px; font-size:12px; margin:4px 6px 0 0; }

    .flex-row{ display:flex; gap:12px; flex-wrap:wrap; }
    .kv{ display:flex; flex-direction:column; background:#fafafa; border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:13px; margin-bottom:8px; }
    .kv strong{ color:#111827; margin-bottom:4px; }

    /* Professional Adjacent Localities Card Styles */
    .adjacent-locality-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 10px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      animation: cardSlideIn 0.3s ease forwards;
      opacity: 0;
    }

    @keyframes cardSlideIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .adjacent-locality-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .adjacent-locality-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f3f4f6;
    }

    .adjacent-locality-name {
      font-size: 15px;
      font-weight: 600;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.01em;
    }

    .adjacent-locality-name::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
    }

    .adjacent-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      color: #6b7280;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      min-width: 28px;
      border: 1px solid #e5e7eb;
    }

    .adjacent-localities-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 0;
    }

    .adjacent-locality-tag {
      display: inline-flex;
      align-items: center;
      background: #f9fafb;
      color: #374151;
      border: 1px solid #e5e7eb;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.15s ease;
      letter-spacing: -0.01em;
    }

    .adjacent-locality-tag:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
      color: #111827;
    }

    .adjacent-locality-tag::before {
      content: '';
      width: 0;
      height: 0;
      margin: 0;
    }

    .adjacent-empty-message {
      color: #6b7280;
      font-size: 13px;
      font-weight: 400;
      font-style: italic;
      padding: 8px 0;
    }

    .adjacent-empty-state {
      text-align: center;
      padding: 32px 24px;
      color: #6b7280;
      font-size: 14px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      font-weight: 400;
    }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="card">
      <div class="grid">
        <div class="full">
          <label for="locality">
            Locality
            <span class="selection-count" id="localityCount" style="display: none;"></span>
          </label>
          <div class="autocomplete-container">
            <input type="text" id="locality" placeholder="Search and select localities" />
            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
            <div class="multiselect-selected" id="localitySelected"></div>
          </div>
          <div class="hint" id="localityHint">Type to search and select one or more localities</div>
        </div>

        <div class="full">
          <label for="bhk">BHK (number)</label>
          <div class="multiselect-container">
            <div class="multiselect-display" id="bhkDisplay" onclick="toggleBhkDropdown()">
              <span class="multiselect-placeholder">Select BHK</span>
              <span class="multiselect-arrow">▼</span>
            </div>
            <div class="multiselect-dropdown" id="bhkDropdown" style="display: none;">
              <div class="multiselect-option" onclick="handleBhkOptionClick(1, event)"><input type="checkbox" id="bhk-1" value="1" /><label for="bhk-1">1</label></div>
              <div class="multiselect-option" onclick="handleBhkOptionClick(2, event)"><input type="checkbox" id="bhk-2" value="2" /><label for="bhk-2">2</label></div>
              <div class="multiselect-option" onclick="handleBhkOptionClick(3, event)"><input type="checkbox" id="bhk-3" value="3" /><label for="bhk-3">3</label></div>
              <div class="multiselect-option" onclick="handleBhkOptionClick(4, event)"><input type="checkbox" id="bhk-4" value="4" /><label for="bhk-4">4</label></div>
              <div class="multiselect-option" onclick="handleBhkOptionClick(5, event)"><input type="checkbox" id="bhk-5" value="5" /><label for="bhk-5">5</label></div>
            </div>
            <div class="multiselect-selected" id="bhkSelected"></div>
          </div>
          <div class="hint">Select one or more BHK options</div>
        </div>

        <div class="full">
          <label for="budgetMax">Budget (Maximum)</label>
          <div class="budget-container">
            <div class="budget-input-wrapper">
              <span class="currency-symbol">₹</span>
              <input type="number" id="budgetMax" placeholder="Enter maximum budget" min="0" step="1000" />
            </div>
            <button type="button" class="budget-increase-btn" onclick="increaseBudget()" title="Add ₹2,000">
              <span class="btn-icon">+</span>
            </button>
          </div>
          <div class="hint" id="budgetHint">Enter maximum budget amount</div>
        </div>

        <div class="full">
          <label for="radius">Radius (km)</label>
          <div class="radius-container">
            <button type="button" class="radius-btn" id="radiusDecrease" onclick="decreaseRadius()" title="Decrease radius">−</button>
            <div class="radius-input-wrapper">
              <input type="number" id="radius" name="radius" min="0" max="5" value="1" step="1" />
            </div>
            <button type="button" class="radius-btn" id="radiusIncrease" onclick="increaseRadius()" title="Increase radius">+</button>
          </div>
          <div class="hint" id="radiusHint">Enter radius between 0-5 km</div>
        </div>

        <div class="full">
          <button class="action-btn" onclick="checkCount()">Show Matches</button>
        </div>
      </div>

      <div class="results" id="results" style="display:none;">
        <div class="result-count">
          <div class="num" id="propCount">0</div>
          <div class="sub" id="summaryText">properties match your filters</div>
        </div>

        <div class="result-section" id="radiusSection" style="display: none;">
          <div class="section-title">Radius Expansion</div>
          <div class="kv"><strong>< 2 km</strong><span id="r2km">—</span><span id="r2kmCount">0 props</span></div>
          <div class="kv"><strong>< 5 km</strong><span id="r5km">—</span><span id="r5kmCount">0 props</span></div>
        </div>

        <div class="result-section" id="budgetFlex" style="display: none;">
          <div class="section-title">Budget Flexibility</div>
          <div class="flex-row">
            <span class="pill" id="inc2k">+₹2k → 0 props</span>
            <span class="pill" id="inc5k">+₹5k → 0 props</span>
          </div>
        </div>

        <div class="result-section" id="adjacentLocalitiesSection" style="display: none;">
          <div class="section-title">Adjacent Localities</div>
          <div id="adjacentLocalitiesContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Autocomplete functionality
    let debounceTimer;
    let selectedIndex = -1;
    let suggestions = [];
    let selectedLocalities = []; 
    let cache = new Map(); 
    let isLoading = false;
    let lastSearchQuery = ''; 
    let isProgrammaticUpdate = false; 

    const localityInput = document.getElementById('locality');
    const dropdown = document.getElementById('autocompleteDropdown');

    function debounce(func, wait) {
      return function executedFunction(...args) {
        const later = () => { clearTimeout(debounceTimer); func(...args); };
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(later, wait);
      };
    }

    function getCachedResults(query) { return cache.get(query.toLowerCase().trim()); }
    function cacheResults(query, results) {
      cache.set(query.toLowerCase().trim(), results);
      if (cache.size > 100) { const firstKey = cache.keys().next().value; cache.delete(firstKey); }
    }

    async function fetchSuggestions(query) {
      if (!query || query.length < 2) {
        if (suggestions.length === 0) hideDropdown();
        return;
      }
      lastSearchQuery = query;
      const cachedResults = getCachedResults(query);
      if (cachedResults) { suggestions = cachedResults; displaySuggestions(cachedResults); return; }
      if (isLoading) return;
      isLoading = true;
      showLoading();

      try {
        const encodedQuery = encodeURIComponent(query);
        const targetUrl = `https://regions.housing.com/api/v1/polygon/suggest/?service_type=rent&feature_type=locality,sublocality,neighbourhood&input=${encodedQuery}`;
        // Use local proxy to avoid CORS issues
        const proxyUrl = `/api/proxy?url=${encodeURIComponent(targetUrl)}`;
        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          credentials: 'same-origin'
        });
        if (!response.ok) throw new Error(`API request failed: ${response.status}`);
        const data = await response.json();
        if (!data) throw new Error('No data received');
        cacheResults(query, data);
        suggestions = data;
        displaySuggestions(data);
      } catch (error) {
        console.error(error);
        showNoResults('Unable to fetch localities.');
      } finally { isLoading = false; }
    }

    // Get all unique bounding_box_uuids from selected localities
    function getSelectedBoundingBoxUuids() {
      const allBoundingBoxUuids = new Set();
      selectedLocalities.forEach(locality => {
        if (locality.bounding_box_uuids && Array.isArray(locality.bounding_box_uuids)) {
          locality.bounding_box_uuids.forEach(uuid => allBoundingBoxUuids.add(uuid));
        }
      });
      return Array.from(allBoundingBoxUuids);
    }

    // Filter suggestions based on shared bounding_box_uuids
    function filterSuggestionsByBoundingBox(data) {
      if (selectedLocalities.length === 0) {
        return data; // No filtering if no localities are selected
      }

      const selectedBoundingBoxUuids = getSelectedBoundingBoxUuids();
      if (selectedBoundingBoxUuids.length === 0) {
        return data; // No bounding boxes to filter by
      }

      return data.filter(item => {
        if (!item.bounding_box_uuids || !Array.isArray(item.bounding_box_uuids)) {
          return false; // Exclude items without bounding_box_uuids
        }
        // Check if item shares at least one bounding_box_uuid with selected localities
        return item.bounding_box_uuids.some(uuid => selectedBoundingBoxUuids.includes(uuid));
      });
    }

    function displaySuggestions(data) {
      if (!data || data.length === 0) { showNoResults(); return; }
      
      // Filter suggestions based on bounding_box_uuids if localities are selected
      const filteredData = filterSuggestionsByBoundingBox(data);
      
      if (filteredData.length === 0) {
        showNoResults(selectedLocalities.length > 0 
          ? 'No localities found in the same area. Try a different search.' 
          : 'No localities found');
        return;
      }

      dropdown.innerHTML = '';
      selectedIndex = -1;
      filteredData.forEach((item, index) => {
        const itemElement = document.createElement('div');
        itemElement.className = 'autocomplete-item';
        itemElement.dataset.index = index;
        if (selectedLocalities.some(loc => loc.uuid === item.uuid)) itemElement.classList.add('selected-item');
        itemElement.innerHTML = `<div class="name">${item.name}</div><div class="type">${item.type} • ${item.super_type}</div>`;
        itemElement.addEventListener('click', (e) => toggleLocalityItem(item, e));
        itemElement.addEventListener('mouseenter', () => { selectedIndex = index; updateSelection(); });
        dropdown.appendChild(itemElement);
      });
      showDropdown();
    }

    function showLoading() { dropdown.innerHTML = '<div class="loading">Searching localities...</div>'; showDropdown(); }
    function showNoResults(message = 'No localities found') { dropdown.innerHTML = `<div class="no-results">${message}</div>`; showDropdown(); }
    function showDropdown() { dropdown.style.display = 'block'; }
    function hideDropdown() { dropdown.style.display = 'none'; selectedIndex = -1; }

    function toggleLocalityItem(item, event) {
      if (event) { event.stopPropagation(); event.preventDefault(); }
      const existingIndex = selectedLocalities.findIndex(loc => loc.uuid === item.uuid);
      if (existingIndex >= 0) selectedLocalities.splice(existingIndex, 1);
      else selectedLocalities.push(item);
      updateLocalityDisplay();
      isProgrammaticUpdate = true;
      localityInput.value = '';
      setTimeout(() => { localityInput.focus(); isProgrammaticUpdate = false; }, 10);
      if (suggestions.length > 0) displaySuggestions(suggestions);
      else if (lastSearchQuery && lastSearchQuery.length >= 2) fetchSuggestions(lastSearchQuery);
    }

    function updateLocalityDisplay() {
      const selectedContainer = document.getElementById('localitySelected');
      const countBadge = document.getElementById('localityCount');
      const hintText = document.getElementById('localityHint');
      const currentUuids = Array.from(selectedContainer.children).map(tag => tag.dataset.uuid || '').filter(Boolean);
      const selectedUuids = selectedLocalities.map(loc => loc.uuid);
      
      if (selectedLocalities.length > 0) {
        countBadge.textContent = `${selectedLocalities.length} selected`;
        countBadge.style.display = 'inline-block';
        hintText.textContent = `${selectedLocalities.length} selected. Showing only localities in the same area.`;
        hintText.style.color = 'var(--primary)';
      } else {
        countBadge.style.display = 'none';
        hintText.textContent = 'Type to search and select one or more localities';
        hintText.style.color = 'var(--muted)';
      }
      
      Array.from(selectedContainer.children).forEach(tag => {
        if (tag.dataset.uuid && !selectedUuids.includes(tag.dataset.uuid)) tag.remove();
      });
      
      selectedLocalities.forEach((locality, index) => {
        if (!currentUuids.includes(locality.uuid)) {
          const tag = document.createElement('span');
          tag.className = 'multiselect-tag';
          tag.dataset.uuid = locality.uuid;
          tag.innerHTML = `${locality.name} <span class="multiselect-tag-remove" onclick="removeLocality('${locality.uuid}', event)">×</span>`;
          selectedContainer.appendChild(tag);
        }
      });
    }

    function removeLocality(uuid, event) {
      event.stopPropagation();
      selectedLocalities = selectedLocalities.filter(loc => loc.uuid !== uuid);
      updateLocalityDisplay();
      if (suggestions.length > 0 && dropdown.style.display === 'block') displaySuggestions(suggestions);
    }

    function updateSelection() {
      const items = dropdown.querySelectorAll('.autocomplete-item');
      items.forEach((item, index) => item.classList.toggle('selected', index === selectedIndex));
    }

    function handleKeydown(event) {
      const items = dropdown.querySelectorAll('.autocomplete-item');
      if (event.key === 'ArrowDown') { event.preventDefault(); selectedIndex = Math.min(selectedIndex + 1, items.length - 1); updateSelection(); }
      else if (event.key === 'ArrowUp') { event.preventDefault(); selectedIndex = Math.max(selectedIndex - 1, -1); updateSelection(); }
      else if (event.key === 'Enter') { event.preventDefault(); if (selectedIndex >= 0 && suggestions[selectedIndex]) toggleLocalityItem(suggestions[selectedIndex], event); }
      else if (event.key === 'Escape') hideDropdown();
    }

    localityInput.addEventListener('input', debounce((e) => { if (!isProgrammaticUpdate) fetchSuggestions(e.target.value); }, 500));
    localityInput.addEventListener('keydown', handleKeydown);
    document.addEventListener('click', (e) => { if (!localityInput.contains(e.target) && !dropdown.contains(e.target)) hideDropdown(); });
    localityInput.addEventListener('focus', () => { if (suggestions.length > 0) showDropdown(); else if (lastSearchQuery.length >= 2) fetchSuggestions(lastSearchQuery); });
    dropdown.addEventListener('mouseleave', () => { selectedIndex = -1; updateSelection(); });

    // BHK Multiselect
    let selectedBhkValues = [];
    function toggleBhkDropdown() {
      const container = document.querySelector('.multiselect-container');
      container.classList.toggle('active');
      document.getElementById('bhkDropdown').style.display = container.classList.contains('active') ? 'block' : 'none';
    }
    function handleBhkOptionClick(value, event) {
      // Stop event from bubbling to document click handler
      event.stopPropagation();
      
      const checkbox = document.getElementById(`bhk-${value}`);
      const target = event.target;
      
      // If clicking directly on checkbox, let it handle its own toggle
      // The change event will handle the state sync
      if (target === checkbox) {
        return; // Let checkbox toggle naturally, change event will sync
      }
      
      // If clicking on label, the label's 'for' attribute will toggle the checkbox
      // So we just let it happen - the change event will sync the state
      if (target.tagName === 'LABEL') {
        return; // Label's 'for' will toggle checkbox, change event will sync
      }
      
      // If clicking on the option div (but not checkbox or label), toggle the checkbox
      checkbox.checked = !checkbox.checked;
      // Manually trigger change event to ensure sync happens
      checkbox.dispatchEvent(new Event('change'));
    }

    function syncBhkState(value, isChecked) {
      if (isChecked) {
        if (!selectedBhkValues.includes(value)) selectedBhkValues.push(value);
      } else {
        selectedBhkValues = selectedBhkValues.filter(v => v !== value);
      }
      updateBhkDisplay();
    }

    function toggleBhkOption(value) {
      const checkbox = document.getElementById(`bhk-${value}`);
      checkbox.checked = !checkbox.checked;
      syncBhkState(value, checkbox.checked);
    }

    // Initialize checkbox change event listeners
    // Since script is at bottom of body, DOM is already loaded
    (function initBhkCheckboxes() {
      for (let i = 1; i <= 5; i++) {
        const checkbox = document.getElementById(`bhk-${i}`);
        if (checkbox) {
          checkbox.addEventListener('change', function() {
            syncBhkState(i, this.checked);
          });
        }
      }
    })();
    function updateBhkDisplay() {
      const display = document.getElementById('bhkDisplay');
      const placeholder = display.querySelector('.multiselect-placeholder');
      const selectedContainer = document.getElementById('bhkSelected');
      selectedContainer.innerHTML = '';
      if (selectedBhkValues.length === 0) { placeholder.textContent = 'Select BHK'; placeholder.style.color = '#999'; }
      else {
        placeholder.textContent = `${selectedBhkValues.length} selected`; placeholder.style.color = '#111827';
        selectedBhkValues.sort().forEach(value => {
          const tag = document.createElement('span');
          tag.className = 'multiselect-tag';
          tag.innerHTML = `${value} BHK <span class="multiselect-tag-remove" onclick="removeBhkOption(${value}, event)">×</span>`;
          selectedContainer.appendChild(tag);
        });
      }
    }
    function removeBhkOption(value, event) {
      event.stopPropagation();
      const checkbox = document.getElementById(`bhk-${value}`);
      checkbox.checked = false;
      // Dispatch change event to ensure consistency with other handlers
      checkbox.dispatchEvent(new Event('change'));
    }
    document.addEventListener('click', (e) => {
      const container = document.querySelector('.multiselect-container');
      if (container && !container.contains(e.target)) { container.classList.remove('active'); document.getElementById('bhkDropdown').style.display = 'none'; }
    });

    // Query Params
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        agentId: params.get('Agent_ID') || params.get('agent_id') || params.get('AgentID') || null,
        userPhone: params.get('User_phone') || params.get('user_phone') || params.get('UserPhone') || null
      };
    }

    // Budget Logic
    function increaseBudget() {
      const budgetInput = document.getElementById('budgetMax');
      const newValue = (parseFloat(budgetInput.value) || 0) + 2000;
      budgetInput.value = newValue;
      budgetInput.style.transform = 'scale(1.02)';
      setTimeout(() => { budgetInput.style.transform = ''; }, 200);
      const hintText = document.getElementById('budgetHint');
      if (hintText) {
        hintText.textContent = `Budget set to ₹${newValue.toLocaleString('en-IN')}`;
        hintText.style.color = 'var(--primary)';
        setTimeout(() => { hintText.textContent = 'Enter maximum budget amount'; hintText.style.color = 'var(--muted)'; }, 2000);
      }
    }

    // Radius Logic
    let selectedRadius = 1; // Default to 1 km (can be 0-5)

    const radiusInput = document.getElementById('radius');
    const radiusDecreaseBtn = document.getElementById('radiusDecrease');
    const radiusIncreaseBtn = document.getElementById('radiusIncrease');
    const radiusHint = document.getElementById('radiusHint');

    function updateRadiusValue(value) {
      // Clamp value between 0 and 5
      const clampedValue = Math.max(0, Math.min(5, parseInt(value) || 0));
      selectedRadius = clampedValue;
      radiusInput.value = clampedValue;
      
      // Update button states
      radiusDecreaseBtn.disabled = clampedValue <= 0;
      radiusIncreaseBtn.disabled = clampedValue >= 5;
      
      // Update hint
      if (clampedValue === 0) {
        radiusHint.textContent = 'No radius limit (exact locality only)';
      } else {
        radiusHint.textContent = `Search radius set to ${clampedValue} km`;
      }
      radiusHint.style.color = 'var(--primary)';
      
      // Add visual feedback
      radiusInput.style.transform = 'scale(1.02)';
      setTimeout(() => { radiusInput.style.transform = ''; }, 200);
    }

    function decreaseRadius() {
      const currentValue = parseInt(radiusInput.value) || 0;
      if (currentValue > 0) {
        updateRadiusValue(currentValue - 1);
      }
    }

    function increaseRadius() {
      const currentValue = parseInt(radiusInput.value) || 0;
      if (currentValue < 5) {
        updateRadiusValue(currentValue + 1);
      }
    }

    // Initialize radius input
    if (radiusInput) {
      updateRadiusValue(radiusInput.value);
      
      // Handle direct input
      radiusInput.addEventListener('input', (e) => {
        updateRadiusValue(e.target.value);
      });
      
      // Handle blur to ensure value is within range
      radiusInput.addEventListener('blur', (e) => {
        updateRadiusValue(e.target.value);
      });
      
      // Prevent invalid values on keypress
      radiusInput.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          increaseRadius();
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          decreaseRadius();
        }
      });
    }

    // Fetch adjacent localities for a given locality UUID
    async function fetchAdjacentLocalities(localityUuid, radius = 5) {
      try {
        const targetUrl = `https://regions.housing.com/api/v1/similar_localities?locality_uuid=${localityUuid}&service=rent&count=5&radius=${radius}`;
        const proxyUrl = `/api/proxy?url=${encodeURIComponent(targetUrl)}`;
        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          credentials: 'same-origin'
        });
        
        if (!response.ok) throw new Error(`API request failed: ${response.status}`);
        const data = await response.json();
        
        // API Response structure: { "selected_locality": {...}, "data": [...] }
        // Each item in data array has "polygon_name" field
        // Extract polygon_name from data.data array and limit to max 5
        if (data && data.data && Array.isArray(data.data)) {
          const adjacentNames = data.data
            .slice(0, 5) // Ensure max 5 items per locality
            .map(item => {
              // Extract polygon_name field from each item
              return item.polygon_name || item.name || '';
            })
            .filter(Boolean); // Remove empty strings
          
          console.log(`Fetched ${adjacentNames.length} adjacent localities for ${localityUuid} with radius ${radius}`);
          return adjacentNames;
        }
        console.warn(`Invalid API response structure for ${localityUuid}:`, data);
        return [];
      } catch (error) {
        console.error(`Error fetching adjacent localities for ${localityUuid}:`, error);
        return [];
      }
    }

    async function checkCount(){
      const maxBudget = parseFloat(document.getElementById('budgetMax').value);
      // GET RADIUS VALUE from number input
      const radiusVal = selectedRadius !== undefined ? selectedRadius : (parseInt(document.getElementById('radius').value) || 0);

      const resultsEl = document.getElementById('results');
      const countEl = document.getElementById('propCount');
      const summaryEl = document.getElementById('summaryText');
      const queryParams = getQueryParams();
      const agentId = queryParams.agentId;
      const userPhone = queryParams.userPhone;

      const localityUuids = selectedLocalities.map(loc => loc.uuid).filter(Boolean);
      const localityNames = selectedLocalities.map(loc => loc.name);
      const bhkList = [...selectedBhkValues].filter(bhk => bhk != null).sort((a, b) => a - b);

      if(localityUuids.length === 0 || bhkList.length === 0 || isNaN(maxBudget) || maxBudget <= 0){
        resultsEl.style.display = 'block';
        countEl.textContent = '—';
        summaryEl.textContent = 'Please enter valid details (Locality, BHK, Budget)';
        return;
      }

      resultsEl.style.display = 'grid';
      countEl.textContent = 'Loading...';
      summaryEl.textContent = 'Fetching property count...';
      
      const startTime = performance.now();

      try {
        const localityUuidsString = localityUuids.join(',');
        const bhkString = bhkList.join(',');

        const baseUrl = 'https://casa.housing.com/api/v1/flat/owner-count';
        let targetUrl = `${baseUrl}?locality_uuids=${localityUuidsString}&service_type=rent&bhks=${bhkString}&price=${maxBudget}`;
        
        // ADD RADIUS (only if > 0, 0 means no radius limit)
        if (radiusVal > 0) {
          targetUrl += `&radius_in_km=${radiusVal}`;
        }
        
        // APPEND Agent_ID AND User_phone AT THE VERY END
        if (agentId) targetUrl += `&agent_id=${encodeURIComponent(agentId)}`;
        if (userPhone) targetUrl += `&user_phone=${encodeURIComponent(userPhone)}`;
        
        console.log('Calling API:', targetUrl);

        // Use local proxy to avoid CORS issues
        const proxyUrl = `/api/proxy?url=${encodeURIComponent(targetUrl)}`;
        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          credentials: 'same-origin'
        });
        
        if (!response.ok) throw new Error(`API request failed: ${response.status}`);
        const data = await response.json();
        
        if (data && data.data && typeof data.data.count === 'number') {
          const count = data.data.count;
          
          // Display count with simple label - no detailed summary text
          countEl.textContent = String(count);
          summaryEl.textContent = 'Properties';
          summaryEl.style.display = 'block';
          summaryEl.style.fontSize = '12px';
          summaryEl.style.color = '#6b7280';
          summaryEl.style.fontWeight = '500';
          
          // UI Simulations
          const near2 = [localityNames[0]+" East", localityNames[0]+" West"];
          const near5 = [localityNames[0]+" Extension", "Green Park"];
          document.getElementById('r2km').textContent = near2.join(', ');
          document.getElementById('r2kmCount').textContent = `${Math.round(count * 0.4)} props`;
          document.getElementById('r5km').textContent = near5.join(', ');
          document.getElementById('r5kmCount').textContent = `${Math.round(count * 0.7)} props`;
          document.getElementById('inc2k').textContent = `+₹2k → ${Math.round(count * 1.05)} props`;
          document.getElementById('inc5k').textContent = `+₹5k → ${Math.round(count * 1.1)} props`;
        }

        // Fetch and display adjacent localities for each selected locality
        // Use radius from form (radiusVal), default to 5 if not set
        await fetchAndDisplayAdjacentLocalities(radiusVal || 5);
      } catch (error) {
        console.error(error);
        countEl.textContent = 'Error';
        summaryEl.textContent = `Failed to fetch data: ${error.message}`;
      }
    }

    // Fetch and display adjacent localities for all selected localities
    async function fetchAndDisplayAdjacentLocalities(radius = 5) {
      const adjacentSection = document.getElementById('adjacentLocalitiesSection');
      const adjacentContent = document.getElementById('adjacentLocalitiesContent');
      
      if (selectedLocalities.length === 0) {
        adjacentSection.style.display = 'none';
        return;
      }

      adjacentSection.style.display = 'block';
      adjacentContent.innerHTML = '<div class="loading">Fetching adjacent localities...</div>';

      try {
        // Fetch adjacent localities for each selected locality in parallel
        const adjacentPromises = selectedLocalities.map(async (locality) => {
          const adjacentNames = await fetchAdjacentLocalities(locality.uuid, radius);
          return {
            baseName: locality.name,
            adjacentNames: adjacentNames
          };
        });

        const results = await Promise.all(adjacentPromises);
        
        // Display results with enhanced UI - show card for all base localities
        adjacentContent.innerHTML = '';

        results.forEach((result, index) => {
          const card = document.createElement('div');
          card.className = 'adjacent-locality-card';
          
          // Add subtle animation delay for staggered effect
          card.style.animationDelay = `${index * 0.05}s`;
          
          const header = document.createElement('div');
          header.className = 'adjacent-locality-header';
          
          const nameDiv = document.createElement('div');
          nameDiv.className = 'adjacent-locality-name';
          nameDiv.textContent = result.baseName;
          
          const countBadge = document.createElement('span');
          countBadge.className = 'adjacent-count-badge';
          countBadge.textContent = result.adjacentNames.length;
          
          header.appendChild(nameDiv);
          header.appendChild(countBadge);
          
          const listDiv = document.createElement('div');
          listDiv.className = 'adjacent-localities-list';
          
          // Display adjacent localities or empty state message
          if (result.adjacentNames.length > 0) {
            result.adjacentNames.forEach((name) => {
              const tag = document.createElement('span');
              tag.className = 'adjacent-locality-tag';
              tag.textContent = name;
              listDiv.appendChild(tag);
            });
          } else {
            // Show empty state message within the card
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'adjacent-empty-message';
            emptyMessage.textContent = 'No adjacent localities found';
            listDiv.appendChild(emptyMessage);
          }
          
          card.appendChild(header);
          card.appendChild(listDiv);
          adjacentContent.appendChild(card);
        });
      } catch (error) {
        console.error('Error fetching adjacent localities:', error);
        adjacentContent.innerHTML = '<div class="no-results">Failed to fetch adjacent localities</div>';
      }
    }
  </script>
</body>
</html>
